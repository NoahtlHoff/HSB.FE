@model HackStreeBoys_Website.Models.ChatViewModel
@using System.Collections.Generic
@using System.Text.Json
@using System.Text.Encodings.Web
@using System.Globalization
@inject IConfiguration Configuration

@{
    var jsonOptions = new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };
    var seedJson = JsonSerializer.Serialize(Model, jsonOptions);
}

<section class="chat-page chat-page--no-watchlist">
    <div class="chat-sidebar-container">
        <aside class="chat-filters" data-profiles="@Html.Raw(JsonSerializer.Serialize(Model.TraderProfiles, jsonOptions))" data-profile-panel aria-hidden="false" tabindex="-1">
            <button type="button" class="profile-panel-close" data-profile-panel-close aria-label="Close profile panel">&times;</button>
            <h2>Your Profile</h2>
            <p>Set trader type, strategies, and risk tolerance so the copilot tailors discovery, risk limits, and timing to you.</p>

            <label for="traderSelect">Trader</label>
            <select id="traderSelect" class="selector">
                @foreach (var profile in Model.TraderProfiles)
                {
                    <option value="@profile.Id">@profile.Label</option>
                }
            </select>

            <label for="strategySelect">Strategy</label>
            <select id="strategySelect" class="selector">
                @{
                    var initialStrategies = Model.TraderProfiles.FirstOrDefault()?.Strategies ?? new List<StrategyOption>();
                }
                @foreach (var strategy in initialStrategies)
                {
                    <option value="@strategy.Id" data-description="@strategy.Description">@strategy.Label</option>
                }
            </select>
            <p id="strategyNotes" class="strategy-notes">@initialStrategies.FirstOrDefault()?.Description</p>


        </aside>

        <aside class="chat-history-sidebar" aria-hidden="false">
            <h2>Previous Chats</h2>
            <div id="chatHistoryList" class="chat-history-list">
                <!-- Chat history items will be injected here -->
            </div>
        </aside>
    </div>

    <div class="chat-main" id="chatMain" data-empty="true">
        <div class="chat-welcome" id="chatWelcome">
            <span class="eyebrow">Realtime Stock Advisor</span>
            <h1>Let's Trade</h1>
            <p>Ask anything about trade plans, risk limits, or market context. The copilot will start a new conversation when you send your first message.</p>
        </div>

        <button class="profile-mobile-trigger" type="button" data-profile-panel-toggle>
            <span class="trigger-label">Trader profile</span>
            <span class="trigger-value" id="profileSummary">Adjust settings</span>
        </button>

        <header class="chat-header">
            <span class="eyebrow">Realtime Copilot</span>
            <h1>Ask for stock recommendation, company fundamental, or trade plans tuned to you.</h1>
        </header>

        <div class="chat-thread" id="chatLog" aria-live="polite"></div>

        <form class="chat-composer" id="chatComposer">
            <label class="visually-hidden" for="chatInput">Ask the copilot for stock ideas</label>
            <input id="chatInput" type="text" placeholder="Ask anything..." autocomplete="off" />
            <button type="submit" aria-label="Send message">
                <span aria-hidden="true">âž¤</span>
            </button>
        </form>

        <p class="chat-hint">Copilot can make mistakes. Verify critical information.</p>
    </div>
</section>

<script type="application/json" id="chat-seed">@Html.Raw(seedJson)</script>
@section Scripts
{
    @* Inject the API base URL from appsettings.json *@
    @{
        var apiBaseUrl = Configuration["ApiSettings:BaseUrl"];
    }

    <script>
        window.API_BASE_URL = "@apiBaseUrl";
        window.USER_ID = "@Model.UserId";
        window.JWT_TOKEN = "@Model.JwtToken";
        window.currentConversationId = "";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="~/js/chat.js" asp-append-version="true"></script>
}
